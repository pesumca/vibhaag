name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5
      - run: bun install
      - run: bun run lint
      - run: MONGO_URL=mongodb://localhost:27017/vibhaag_test bun run test
      - run: bun run ui:install
      - run: |
          MONGO_URL=mongodb://localhost:27017/vibhaag CORS_ORIGIN=http://localhost:5173 JWT_SECRET=ci-secret bun --cwd apps/api run dev > /tmp/api.log 2>&1 &
          VITE_API_URL=http://localhost:4000 bun --cwd apps/web run dev -- --host 0.0.0.0 --port 5173 > /tmp/web.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://localhost:4000/health && break
            sleep 2
          done
          for i in {1..30}; do
            curl -sSf http://localhost:5173 && break
            sleep 2
          done
      - run: MONGO_URL=mongodb://localhost:27017/vibhaag bun run seed
      - run: UI_BASE_URL=http://localhost:5173 API_BASE_URL=http://localhost:4000 bun run test:ui
